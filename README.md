# Discord × Copilot — Remote Coding Agent

Autonomy-first Remote Coding Agent: **Discord** als Frontend, **GitHub Copilot CLI** als Agent-Backend über SDK.

## Quick Start

```bash
# 1. Prerequisites
#    - git, node (>=18), npm, copilot CLI or gh copilot (authenticated)

# 2. Set Discord Bot Token (or use .env file)
export DISCORD_TOKEN="your-bot-token-here"

# 3. Run
chmod +x agent.sh
./agent.sh
# → Asks for Repo URL, then runs fully automated
```

Alternatively, create a `.env` file next to `agent.sh`:
```env
DISCORD_TOKEN=your-bot-token-here
REPO_URL=https://github.com/user/repo.git
ALLOWED_GUILDS=123456789
```

## How It Works

```
Discord ←→ Bot (Node.js) ←→ @github/copilot-sdk ←→ copilot CLI (ACP/stdio)
                ↕
          Policy Engine
         (onPreToolUse)
```

The agent works **autonomously** within the workspace. Remote interactions in Discord happen **only** for:

1. **`git push` / PR publish** — Always requires Discord approval
2. **Access outside workspace** — Denied by default, grantable via `/grant`

## Commands

| Command | Description |
|---------|-------------|
| `/task prompt:<text>` | Send a task to the agent |
| `/status` | Show session status, queue, grants |
| `/approve_push` | Approve a pending git push |
| `/grant path:<abs> mode:ro\|rw ttl:<min>` | Grant access to a path outside workspace |
| `/revoke path:<abs>` | Revoke a path grant |
| `/reset` | Reset the agent session |

## Environment Variables

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `DISCORD_TOKEN` | **Yes** | — | Discord bot token |
| `REPO_URL` | No | _(prompted)_ | Skip the interactive prompt |
| `ALLOWED_GUILDS` | No | _(all)_ | Comma-separated guild IDs |
| `ALLOWED_CHANNELS` | No | _(all)_ | Comma-separated channel IDs |
| `ADMIN_ROLE_IDS` | No | _(all)_ | Comma-separated role IDs |
| `BASE_ROOT` | No | `~/.local/share/discord-agent` | Base directory |
| `WORKSPACES_ROOT` | No | `$BASE_ROOT/workspaces` | Worktree directory |

## Architecture

```
~/.local/share/discord-agent/
├── app/                  # Bot application (generated by agent.sh)
│   ├── package.json
│   └── src/
│       ├── bot.mjs              # Discord client, slash commands
│       ├── config.mjs           # ENV parsing, defaults
│       ├── state.mjs            # SQLite persistence
│       ├── policy-engine.mjs    # onPreToolUse: path security, push detection
│       ├── grants.mjs           # Grant CRUD, TTL, auto-revoke
│       ├── copilot-client.mjs   # SDK integration, session factory
│       ├── session-manager.mjs  # Session lifecycle, queue, worktrees
│       ├── discord-output.mjs   # Streaming output, throttling
│       └── push-approval.mjs    # Push gate, diff summary, buttons
├── repos/<project>/      # Cloned repository (bare worktree source)
├── workspaces/<project>/ # Git worktrees (one per Discord channel)
└── state.sqlite          # Persistent state (sessions, grants, history)
```

## Security

- **Path Security**: `fs.realpathSync()` on all paths — prevents symlink traversal
- **Deny-by-default**: SDK v0.1.25+ denies all tool operations without explicit handler
- **Compound command scanning**: Detects `git push` in `&&`, `||`, `;`, pipe chains and `sh -c` wrappers
- **`cd` target validation**: Shell `cd` commands into paths outside workspace are blocked
- **Auto-revoke**: Grants expire after TTL, cleaned up periodically
- **Workspace isolation**: Each channel gets its own git worktree
- **Flush serialization**: Discord output edits are serialized to prevent race conditions
- **No secrets in logs**: Discord token never printed
- **Session recovery**: Grants are restored from DB on bot restart

## Discord Bot Setup

1. Go to [Discord Developer Portal](https://discord.com/developers/applications)
2. Create Application → Bot → Reset Token → copy
3. Enable **Message Content Intent**
4. Bot Permissions: Send Messages, Embed Links, Attach Files, Use Slash Commands
5. Invite with OAuth2 URL (scope: `bot`, `applications.commands`)
6. `export DISCORD_TOKEN="..."` and run `./agent.sh`
